#!/bin/bash

git_post(){
	local remote
	local host

	remote=$(git remote -v | grep origin.*fetch)

	case "$remote" in
		*@github* | *https://github.com*)
			host=github
			;;
		*@bitbucket*)
			host=bitbucket
			;;
		*)
			echo "git-post: unknown hosting service. noop"
			exit 1
			;;
	esac

	. git-post-$host
	git_post_pull_request
}
git_post_pull_request(){
	local remote_name
	local remote
	local push_url
	local destination
	local head_branch
	local current

	remote_name=$1; shift
	if [ -z "$remote_name" ]; then
		remote_name=origin
	fi

	echo "pull request -> $remote_name"
	remote=$(git remote show $remote_name)

	push_url=$(echo "$remote" | grep 'Push.*URL')
	push_url=${push_url#*Push*URL: }
	push_url=${push_url%.git}

	case "$push_url" in
		*@*)
			destination=${push_url##*:}
			;;
		*)
			destination=$(basename $(dirname $push_url))/$(basename $push_url)
			;;
	esac

	head_branch=$(echo "$remote" | grep 'HEAD.*branch')
	head_branch=${head_branch#*HEAD*branch: }

	current=$(git current)

	git_post_$host
}

git_post "$@"
