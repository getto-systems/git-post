#!/bin/bash

git_post(){
	local remote_name
	local remote
	local host

	remote_name=$1; shift
	if [ -z "$remote_name" ]; then
		remote_name=origin
	fi

	remote=$(git remote -v | grep $remote_name.*fetch)

	case "$remote" in
		*git://github.com* | *@github* | *https://github.com*)
			host=github
			;;
		*@bitbucket*)
			host=bitbucket
			;;
		*)
			echo "git-post: unknown hosting service. noop"
			exit 1
			;;
	esac

	. git-post-$host
	git_post_pull_request
}
git_post_pull_request(){
	local remote_detail
	local push_url
	local destination
	local head_branch
	local current

	echo "check remote..."
	remote_detail=$(git remote show $remote_name)
	echo

	push_url=$(echo "$remote_detail" | grep 'Push.*URL')
	push_url=${push_url#*Push*URL: }
	push_url=${push_url%.git}

	case "$push_url" in
		*@*)
			destination=${push_url##*:}
			;;
		*)
			destination=$(basename $(dirname $push_url))/$(basename $push_url)
			;;
	esac

	head_branch=$(echo "$remote_detail" | grep 'HEAD.*branch')
	head_branch=${head_branch#*HEAD*branch: }

	current=$(git current)

	echo "PR: $current -> $destination : $remote_name/$head_branch"
	git_post_$host
}

git_post "$@"
