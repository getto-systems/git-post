#!/bin/bash

git_post(){
	local config_root
	local config
	local remote_name
	local remote
	local pub
	local user_name
	local host

	config_root=$HOME/.git-post
	mkdir -p $config_root
	chmod 700 $config_root

	remote_name=$1; shift
	if [ -z "$remote_name" ]; then
		remote_name=origin
	fi

	remote=$(git remote -v | grep $remote_name.*fetch)

	case "$remote" in
		*git://github.com* | *@github* | *https://github.com*)
			host=github
			;;
		*https://*bitbucket*)
			host=bitbucket
			;;
		*)
			echo "git-post: unknown hosting service. noop"
			exit 1
			;;
	esac

	pub=$(git remote -v | grep "^pub	.*fetch")
	if [ -z "$pub" ]; then
		echo "set public remote : named 'pub'"
		exit 1
	fi

	pub=${pub#pub	}
	pub=${pub#https://}
	user_name=${pub%@*}

	git_post_pull_request
}
git_post_pull_request(){
	local remote_detail
	local push_url
	local destination
	local repository
	local head_branch
	local current

	echo "check remote..."
	remote_detail=$(git remote show $remote_name)
	echo

	push_url=$(echo "$remote_detail" | grep 'Push.*URL')
	push_url=${push_url#*Push*URL: }
	push_url=${push_url%.git}

	repository=$(basename $push_url)
	destination=$(basename $(dirname $push_url))/$repository

	head_branch=$(echo "$remote_detail" | grep 'HEAD.*branch')
	head_branch=${head_branch#*HEAD*branch: }

	current=$(git symbolic-ref --short HEAD)

	echo "PR: $current -> $head_branch : $destination"

	config=$config_root/$host-$user_name

	. git-post-$host
	git_post_$host
}

git_post "$@"
