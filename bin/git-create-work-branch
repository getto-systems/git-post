#!/bin/bash

git_create_work_branch_main(){
  local message
  local branch
  local last
  local parent

  message=$1; shift
  if [ -z "$message" ]; then
    echo 'usage: git create-work-branch <commit message>'
    exit 1
  fi

  branch=$(echo "$message" | head -1 | sed -e "s/[^[:alnum:]]\+/-/g")

  parent=$(git parent)

  if [ "$(git symbolic-ref --short HEAD)" == "$parent" ]; then
    git checkout -b $branch &&
      git commit --allow-empty -m "$message" &&
      git pub &&
      git post "$message" "$parent"
  else
    git fetch origin

    last="$(git show -q --format="%H")"
    if [ -z "$(git log "origin/$parent".."$last" --format="%H")" ]; then
      echo "this branch is already merged to origin/$parent"
      return
    fi

    git commit --allow-empty -m "$message" &&
      git pub
  fi
}

git_create_work_branch_main "$@"
