#!/bin/bash

git_create_work_branch_main(){
  local message
  local branch
  local last
  local parent

  message=$1; shift
  if [ -z "$message" ]; then
    echo 'usage: git create-work-branch <commit message>'
    exit 1
  fi

  parent=$(git parent)

  if [ "$(git symbolic-ref --short HEAD)" == "$parent" ]; then
    branch=$(echo "$message" | head -1 | sed -e "s/[^[:alnum:]]\+/-/g")

    git checkout -b $branch &&
    git commit --allow-empty -m "$message" &&
    git pub &&
    git post "$message" "$parent" &&
    :
  else
    branch=$(git symbolic-ref --short HEAD)

    git fetch origin
    git fetch pub

    if [ -z "$(git branch -r --no-merged origin/$parent | grep pub/$branch)" ]; then
      echo "pub/$branch is already merged to origin/$parent"
      return
    fi

    git commit --allow-empty -m "$message" &&
    git pub &&
    :
  fi
}

git_create_work_branch_main "$@"
